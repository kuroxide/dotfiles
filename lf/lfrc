# Interpreter for shell commands
set shell sh

set shellopts '-eu'

# set internal field separator (IFS) to "\n" for shell commands
# This is useful to automatically split file names in $fs and $fx properly
# since default file separator used in these variables (i.e. 'filesep' option)
# is newline. You need to consider the values of these options and create your
# commands accordingly.
set ifs "\n"

set mouse
set scrolloff 8
set cursorpreviewfmt ""
set drawbox
set hidden!
set incfilter
set sortby 'name'

set sixel   # Image preview with sixel
set previewer "~/.config/lf/previewer"

# Unset keybinds to rebind (clearmaps is buggy)
map n
map b
map t
map r

# Actual keybinds
map q quit
map <up> up
map <pgup> half-up
map <s-up> half-up
map <down> down
map <pgdn> half-down
map <s-down> half-down
map <left> updir
map <right> open

map <space> :toggle; down
map u unselect
map l redraw
map e shell

map rr rename
map re rename_ext
map rc rename_clear
map nn newfile
map nf newdir
map c clear
map <c-x> cut
map <c-c> copy
map <c-v> paste
map / filter

map b bookmark_jump
map B bookmark_create

# Trash
map <delete><delete> trash	# Move to trash (gio trash)
map <delete>r untrash		# Restore file from trash (gio trash)
map <delete>P delete			# Permanently delete

map ` !true				# Show the result of execution of previous commands
map x &$f & disown		# Execute current file and detach it
map o &xdg-open $fs & disown	# Open file/dir with mimeo
map <enter> open

# Reference: $ runs normally, & runs silently, ! runs as root

# Dynamically set column ratios
${{
    w=$(tput cols)
    if [ $w -le 80 ]; then
        lf -remote "send $id :set ratios 2:3; set preview false"
    elif [ $w -le 160 ]; then
        lf -remote "send $id set ratios 1:1:2"
    else
        lf -remote "send $id set ratios 1:1:1:4"
    fi
}}

# Bookmark search & create
cmd bookmark_jump ${{
    res="$(cat $LF_BOOKMARK_PATH/$(ls $LF_BOOKMARK_PATH | fzf))"
    lf -remote "send $id cd \"$res\""
}}

cmd bookmark_create ${{
    read ans
    echo $PWD > $LF_BOOKMARK_PATH/$ans
}}

cmd newfile :push %touch<space>
cmd newdir :push %mkdir<space>

cmd trash ${{
    gio trash $fx
}}

cmd untrash ${{
    gio trash --restore "trash:///$(basename $fx)"
}}

cmd rename

# Change window title to path
cmd on-cd &{{
    # '&' commands are not connected to stdout.
    # To make sure our escape sequence still reaches stdout we pipe it to /dev/tty
    printf "\033]0; $PWD\007" > /dev/tty
}}

on-cd

# Nested instance warning
&[ $LF_LEVEL -eq 1 ] || lf -remote "send $id echoerr \"Warning: You're in a nested lf instance!\""
